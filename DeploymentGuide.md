# Deploying the Durable Orchestrator to Azure

This guide provides details for the components deployed to Azure for the DurableOrchestrator project. It also provides step-by-step instructions for deploying the project to Azure.

## Components

- [**Azure Container Apps**](https://learn.microsoft.com/en-us/azure/container-apps/overview/): Azure Container Apps is a simple, cost-effective, fully managed serverless container service that enables you to deploy and run containers without managing the infrastructure. It is used to host the DurableOrchestrator Functions project.
  - [Learn more about hosting Functions on Azure Container Apps](https://learn.microsoft.com/en-us/azure/azure-functions/functions-container-apps-hosting)
- [**Azure Container Registry**](https://learn.microsoft.com/en-us/azure/container-registry/container-registry-intro): Azure Container Registry is a managed, private Docker registry service that stores and manages your container images for Azure deployments. It is used to store the DurableOrchestrator container image.
- [**Azure Key Vault**](https://learn.microsoft.com/en-us/azure/key-vault/general/overview): Azure Key Vault is a service to securely store and manage sensitive information, such as application secrets. It is used by the DurableOrchestrator sample workflows to retrieve secrets.
- [**Azure Storage**](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview): Azure Storage is a simple storage solution for modern data storage scenarios, such as file blobs. It is used by the DurableOrchestrator sample workflows to retrieve and create files.
- [**Azure Text Analytics**](https://learn.microsoft.com/en-us/azure/ai-services/language-service/overview): Azure Text Analytics, a feature of Azure AI Language, is a service that provides advanced natural language processing over raw text. It is used by the DurableOrchestrator sample workflows to analyze text data.
- [**Azure Log Analytics**](https://learn.microsoft.com/en-us/azure/azure-monitor/logs/log-analytics-overview): Azure Log Analytics is a service in Azure Monitor that helps you collect and analyze data generated by resources in your cloud and on-premises environments. Deployed alongside an Azure Application Insights resource, it is used as the observability layer for the DurableOrchestrator project, collecting logs, traces, and metrics.
- [**Azure Managed Identity**](https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/overview):
Managed identities allow keyless authentication from Azure services to other Azure services using role-based access control. It is used to authenticate the deployed DurableOrchestrator container app to Azure Container Registry, Azure Text Analytics, Azure Key Vault, and Azure Storage.

## Getting Started

To deploy the solution and test the workflows of the DurableOrchestrator project, you need to:

### Prerequisites

> [!TIP]
> This project comes with a [**Dev Container**](https://containers.dev/) configuration to simplify the setup of your local environment. Ensure that you have [**Docker Desktop**](https://www.docker.com/products/docker-desktop) installed and running on your machine. Then, open the project in Visual Studio Code and follow the prompts to reopen the project in a Dev Container. **Skip the following steps if you are using the Dev Container**.

Follow these steps to set up a local development environment on your machine:

- Install a code editor, such as [**Visual Studio Code**](https://code.visualstudio.com/) or [**Visual Studio**](https://visualstudio.microsoft.com/).
- Install the latest [**.NET 8 SDK**](https://dotnet.microsoft.com/download).
- Install the [**Azure Functions Core v4 Tools**](https://github.com/Azure/azure-functions-core-tools/tree/4.0.5530?tab=readme-ov-file#installing).
  - This is used to run the DurableOrchestrator project locally.
- Install [**PowerShell Core**](https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell).
- Install the [**Azure CLI**](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli).
- Install [**Docker Desktop**](https://www.docker.com/products/docker-desktop).

> [!TIP]
> If you are using Visual Studio Code, we have provided [recommended extensions](./.vscode/extensions.json) for the project. Open the project in Visual Studio Code and follow the prompts to install the recommended extensions.

### Deploy the core infrastructure

Within the `infra` directory, you will find a [`Deploy-Infrastucture.ps1`](./infra/Deploy-Infrastructure.ps1) script that will provision the core infrastructure for hosting the DurableOrchestrator project. This includes the Azure Container Apps, Azure Container Registry, Azure Key Vault, Azure Storage, Azure Text Analytics, and Azure Log Analytics resources.

> [!NOTE]
> The script requires the Azure CLI to be installed and logged in to an Azure account. Ensure that you have the Azure CLI installed and are logged in to your Azure account before running the script. It will deploy the resources to your default subscription.

1. If you are not logged in to your Azure account, run the following command to log in:

    ```powershell
    az login
    ```

1. If you have multiple Azure subscriptions, run the following command to list the subscriptions and select the one you want to use:

    ```powershell
    az account list --output table
    ```

    ```powershell
    az account set --subscription <subscription-id>
    ```

1. Run the following command from the root of the project to deploy the core infrastructure:

    ```powershell
    .\infra\Deploy-Infrastructure.ps1 -DeploymentName <deployment-name> -Location <location>
    ```

    Replace `<deployment-name>` with a unique name, e.g., `durable-orchestrator`, for the deployment and `<location>`, e.g., `westeurope`, with the Azure region where you want to deploy the resources. This deployment is run at the subscription level, so a resource group will be created for you using the deployment name at the specified location.

> [!NOTE]
> The initial deployment may take roughly 5-10 minutes to complete while the Azure Container Apps environment activates. You should not need to run this script again unless you make changes to the `infra` Bicep templates.

Once complete, a `InfrastructureOutputs.json` file will be created in the `infra` directory. This file contains the output values of the deployed resources, such as the Azure Container Apps URL, Azure Container Registry URL, Azure Key Vault URL, and Azure Storage URL. These values are used to configure the DurableOrchestrator project deployment.

### Deploy the DurableOrchestrator project

With the core infrastructure deployed, you can now deploy the DurableOrchestrator project to Azure. The project is deployed as a containerized Azure Functions app to Azure Container Apps.

Within the `infra\apps\DurableOrchestrator` directory, you will find a [`Deploy-App.ps1`](./infra/apps/DurableOrchestrator/Deploy-App.ps1) script that will use the outputs of the `InfrastructureOutputs.json` file to build, push, and deploy the container to Azure Container Apps.

> [!NOTE]
> Before running the script, ensure you have Docker Desktop installed and running on your machine. The script will use Docker to build the container image and push it to Azure Container Registry. You can find the Dockerfile in the [`src/DurableOrchestrator`](./src/DurableOrchestrator/Dockerfile) directory.

The script will create a new container image using the Dockerfile with the name `durable-orchestrator` with a tag using the current date and time in the format `yyMMddHHmm`, e.g., `durable-orchestrator:2402231116`. It will then push the container image to Azure Container Registry and deploy the container image as an Azure Container App to the previously deployed Azure Container Apps environment.

1. Run the following command from the root of the project to deploy the DurableOrchestrator project:

    ```powershell
    .\infra\apps\DurableOrchestrator\Deploy-App.ps1 -InfrastructureOutputsPath .\infra\InfrastructureOutputs.json
    ```

> [!NOTE]
> The initial build and deployment may take roughly 5-10 minutes to complete. You should not need to run this script again unless you make changes to the `src/DurableOrchestrator` project. For every subsequent deployment, the container image for the previously deployed Azure Container App will be updated, ensuring the URL remains the same.

Once complete, a `AppOutputs.json` file will be created in the `infra\apps\DurableOrchestrator` directory. This file contains the output values of the deployed Azure Container App, including the URL to access the deployed Azure Functions container.

## Testing the Workflows

Located in the `src/DurableOrchestrator/tests` directory, you will find a [`tests.rest`](./src/DurableOrchestrator/tests/tests.rest) file that contains a collection of REST API requests to test the DurableOrchestrator project. You can use the [**REST Client**](https://marketplace.visualstudio.com/items?itemName=humao.rest-client) extension in Visual Studio Code to send these requests to the deployed Azure Container App.

1. Open the `tests.rest` file in Visual Studio Code.
1. For any of the requests, replace `http://localhost:7071` with the URL of the deployed Azure Container App from the `AppOutputs.json` file.
1. Update any request body properties specific to Azure resources with the ones from the `InfrastructureOutputs.json` file, e.g., `storageAccountName`.

> [!NOTE]
> When running the `WorkflowOrc_HttpStart` or `CopyBlobWorkflow_HttpStart` endpoints, these access Azure Key Vault to retrieve a secret named `samplesec`. This secret needs to be created in your Azure Key Vault instance previously deployed. You can use the Azure CLI to create a secret in your Azure Key Vault:
>
>    ```powershell
>    az keyvault secret set --name "samplesec" --value "mysecret" --vault key-vault-name
>    ```
>
> You will need the `Key Vault Secrets Officer` role to create a secret in your Azure Key Vault. If you do not have this role, you can apply it to your account at the deployed Key Vault resource in the portal.
